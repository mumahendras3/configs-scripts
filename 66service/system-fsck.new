[main]
@type = oneshot
@name = system-fsck
@description = "Check filesystem partition"
@user = ( root )
@options = ( env )
@depends = ( system-Devices system-fontnkey )

[start]
@build = auto
@execute = 
(
	execl-envfile ${conf_file}
	ifelse -X { s6-test ${FORCECHCK} = yes }
	{
		redirfd -w 1 /dev/console
		if { 66-echo -- [system-fsck] FORCECHCK was asked... }
		execl-cmdline -s { fsck -f ${cmd_args} }
	}
	if { 66-echo -- [system-fsck] starts... }
	foreground { execl-cmdline -s { fsck ${cmd_args} } }
	importas ? ?
	ifelse { test $? -gt 1 }
	{ 
		if { 66-echo -- fsck reports errors -- at least system should be rebooted }
		redirfd -w 1 /dev/console
		66-echo -- fsck reports errors -- at least system should be rebooted
	}
	if { 66-echo -- [system-fsck] fsck finished succesfully, remounting root device with read-write enabled. }
	ifelse { execl-cmdline { mount -w -n -o remount / } }
	{
		if { 66-echo -- [system-fsck] root device remounted successfully }
		66-echo -- [system-fsck] started successfully
	}
	if { 66-echo -- [system-fsck] remounting root device failed! press Alt+F12 to enter the emergency tty (tty12) and try to fix this problem. }
	redirfd -w 1 /dev/console
	66-echo -- [system-fsck] remounting root device failed! press Alt+F12 to enter the emergency tty (tty12) and try to fix this problem.
)

[environment]
cmd_args=!-A -T -a noopts=_netdev
conf_file=!/etc/66/boot.conf
